
STATICLIBS?=libs

CC=cc
GCC=gcc
CXX=g++

JS_HEADERS= c_src/couch_js/utf8.h

JS_OBJS= \
	c_src/obj/utf8.o \
	c_src/obj/main.o

JS_FILE= share/server/main.js
JS_FILE_COMPONENTS= share/server/json2.js \
					share/server/filter.js \
					share/server/mimeparse.js \
					share/server/render.js \
					share/server/state.js \
					share/server/util.js \
					share/server/validate.js \
					share/server/views.js
JS_FILE_COMPONENTS_LAST = share/server/loop.js    
COFFEE_FILE= share/server/main-coffee.js
COFFEE_FILE_COMPONENTS_LAST = share/server/coffee-script.js \
							  share/server/loop.js



COUCH_EJSON_COMPARE_FILES= \
		c_src/couch_ejson_compare/erl_nif_compat.h \
		c_src/couch_ejson_compare/couch_ejson_compare.c

all: compile 
	@install couchspawnkillable/couchspawnkillable.sh priv/couchspawnkillable

compile: couchjs js icu

clean:
	@rm -f c_src/obj/*.o couchjs
	@rm -f $(JS_FILE)
	@rm -f $(COFFEE_FILE)
	@rm -f priv/*.so
	@rm -f priv/couchspawnkillable

c_src/obj/%.o: c_src/couch_js/%.c $(JS_HEADERS)
	@$(CC) $(JS_CFLAGS) -c -o $@ $<

couchjs: $(JS_OBJS)
	@$(CC) $(JS_CFLAGS) -o $@ $^ $(JS_LIBS)

js: $(JS_FILE) $(COFFEE_FILE)

$(JS_FILE):
	@mkdir -p `dirname $(JS_FILE)`
	@echo "// DO NOT EDIT THIS FILE BY HAND" > $@
	@echo >> $@
	@cat $(JS_FILE_COMPONENTS) $(JS_FILE_COMPONENTS_LAST) >> $@

$(COFFEE_FILE): $(JS_FILE_COMPONENTS) $(COFFEE_FILE_COMPONENTS_LAST)
	@mkdir -p `dirname $(COFFEE_FILE)`
	@echo "// DO NOT EDIT THIS FILE BY HAND" > $@
	@echo >> $@
	@cat $(JS_FILE_COMPONENTS) $(COFFEE_FILE_COMPONENTS_LAST) >> $@

icu: priv/couch_icu_driver.so

priv/couch_icu_driver.so: c_src/icu_driver/couch_icu_driver.c
	@$(CC) $(ICU_CFLAGS) $(ICU_LIBS) $^ -o $@

nifs: couch_ejson_compare

couch_ejson_compare: priv/couch_ejson_compare.so

priv/couch_ejson_compare.so: $(COUCH_EJSON_COMPARE_FILES)
	@$(CC) $(ICU_CFLAGS) $(ICU_LIBS) \
		c_src/couch_ejson_compare/couch_ejson_compare.c \
		-o priv/couch_ejson_compare.so
